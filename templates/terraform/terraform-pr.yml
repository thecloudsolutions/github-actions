name: Terraform PR Check
on:
  pull_request:
permissions:
  contents: read
  pull-requests: write
  
jobs:
  terraform-structure:
    uses: thecloudsolutions/github-actions/.github/workflows/terraform-structure.yml@main
      
  terraform-docs:
    needs: terraform-structure
    uses: thecloudsolutions/github-actions/.github/workflows/terraform-docs.yml@main
      
  terraform-format:
    needs: terraform-docs
    uses: thecloudsolutions/github-actions/.github/workflows/terraform-format.yml@main
    
  terraform-validate:
    needs: terraform-format
    uses: thecloudsolutions/github-actions/.github/workflows/terraform-validate.yml@main
    
  terraform-tflint:  
    uses: thecloudsolutions/github-actions/.github/workflows/terraform-tflint.yml@main
    
  terraform-checkov:
    uses: thecloudsolutions/github-actions/.github/workflows/terraform-checkov.yml@main

  terraform-comment:
    needs: [terraform-structure, terraform-docs, terraform-format, terraform-validate, terraform-tflint, terraform-checkov]
    if: always()
    uses: thecloudsolutions/github-actions/.github/workflows/terraform-comment.yml@main
    with:
      step-name: "Infrastructure Validation Summary"
      step-result: ${{ (needs.terraform-structure.result == 'success' && needs.terraform-docs.result == 'success' && needs.terraform-format.result == 'success' && needs.terraform-validate.result == 'success' && needs.terraform-tflint.result == 'success' && needs.terraform-checkov.result == 'success') && 'success' || 'failure' }}
      success-message: "ðŸŽ‰ All infrastructure code checks passed! Your Terraform changes are ready to deploy! ðŸš€\\n\\nâœ… File naming conventions\\nâœ… Documentation is current\\nâœ… Code formatting\\nâœ… Syntax validation\\nâœ… Code quality (TFLint)\\nâœ… Security scan (Checkov)"
      failure-message: "Infrastructure validation incomplete. Review the specific failed checks above and fix the issues before deploying."
